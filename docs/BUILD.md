# Build System Guide

This plugin uses **CMake as the single source of truth** for build configuration. CMake automatically generates standalone build scripts (`build.sh` and `build.cmd`) that users can run without needing CMake installed.

## Quick Start

### For Developers (with CMake)
```bash
make              # Build + generate standalone scripts
make test         # Run all tests
```

### For Users (without CMake)
```bash
# CMake already generated these scripts for you:
./c-diff-core/build.sh       # Unix/Linux/macOS
c-diff-core\build.cmd        # Windows
```

---

## How It Works

```
┌────────────────────────────────────────────────────────┐
│  Developer Workflow (with CMake)                       │
├────────────────────────────────────────────────────────┤
│  1. Edit CMakeLists.txt (single source of truth)      │
│  2. Run: cmake -B build                                │
│  3. CMake generates:                                   │
│     - Build system (Makefiles/Ninja)                   │
│     - build.sh (Unix standalone script)                │
│     - build.cmd (Windows standalone script)            │
│  4. Commit generated scripts to git                    │
└────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────┐
│  User Workflow (NO CMake needed!)                      │
├────────────────────────────────────────────────────────┤
│  1. Clone repository                                   │
│  2. Run: ./c-diff-core/build.sh                        │
│  3. Done! (scripts were generated by CMake)            │
└────────────────────────────────────────────────────────┘
```

**Key Point:** CMake generates the standalone scripts. Users just run the generated scripts.

---

## Build Options

### For Developers (with CMake)
```bash
make                    # Build + generate scripts
make generate-scripts   # Only generate scripts (no build)
make test              # Run all tests
make test-c            # C tests only
make test-lua          # Lua tests only
make clean             # Clean everything
```

**What happens:**
- CMake reads configuration from `CMakeLists.txt`
- Generates `build.sh` and `build.cmd` with detected compiler/flags
- Builds the library
- Scripts are committed to git for users

### For Users (NO CMake needed)
```bash
# Unix/Linux/macOS
./build.sh

# Windows
build.cmd
```

**What happens:**
- Scripts use hardcoded configuration from CMake
- Compile bundled utf8proc (no external dependency!)
- Build library directly
- **No CMake or external libraries required**

### Direct CMake Usage
```bash
cmake -B build           # Configure (generates scripts)
cmake --build build      # Build
ctest --test-dir build   # Test
```

---

## Supported Compilers

### Unix/Linux/macOS
- GCC 7.0+
- Clang 6.0+
- Any C11-compliant compiler

### Windows
- MSVC 2019+ (Visual Studio)
- Clang for Windows
- MinGW-w64 GCC
- TCC (Tiny C Compiler)

---

## Testing

### All Tests
```bash
make test              # C + Lua tests
cmake --build build --target test-all  # Using CMake directly
```

### C Tests Only
```bash
make test-c
cmake --build build --target test      # Using CMake directly
cd build && ctest --output-on-failure
```

### Lua Tests Only
```bash
make test-lua
./tests/run_tests.sh
```

---

## Platform-Specific Notes

### Linux
```bash
# No dependencies needed! utf8proc is bundled.
sudo apt-get install build-essential cmake   # Only for CMake build

# Build
make
```

### macOS
```bash
# No dependencies needed! utf8proc is bundled.
brew install cmake   # Only for CMake build

# Build
make
```

### Windows

**No dependencies needed! utf8proc is bundled.**

**Option 1: MSVC (Visual Studio)**
```cmd
REM Open "Developer Command Prompt for VS"
cmake -B build
cmake --build build
```

**Option 2: MinGW**
```cmd
cmake -B build -G "MinGW Makefiles"
cmake --build build
```

**Option 3: Standalone (No CMake)**
```cmd
build.cmd
```

---

## Directory Structure

```
vscode-diff.nvim/
├── CMakeLists.txt           # Root CMake configuration
├── Makefile                 # Convenience wrapper
├── c-diff-core/
│   ├── CMakeLists.txt       # C build configuration
│   ├── build.sh             # Standalone build (Unix)
│   ├── build.cmd            # Standalone build (Windows)
│   ├── src/                 # C source files
│   ├── include/             # C headers
│   └── tests/               # C unit tests
├── lua/                     # Lua plugin code
└── tests/
    ├── test_*.lua           # Lua integration tests
    └── run_tests.sh         # Lua test runner
```

---

## Troubleshooting

### "CMake not found"
Use standalone build:
```bash
./build.sh          # Unix/Linux/macOS
build.cmd           # Windows
```

### "No compiler found"
Install one:
- **Linux**: `sudo apt-get install build-essential`
- **macOS**: `xcode-select --install`
- **Windows**: Install Visual Studio or MinGW-w64

---

## Dependencies

**None!** All dependencies are bundled:
- ✅ utf8proc (bundled in `c-diff-core/vendor/`)
- ✅ No external libraries required
- ✅ Works on Windows/Linux/macOS out of the box

---

## Summary

| Method | Command | Best For |
|--------|---------|----------|
| **Make + CMake** | `make` | Most users, CI/CD |
| **CMake direct** | `cmake -B build && cmake --build build` | Power users, IDEs |
| **Standalone** | `./c-diff-core/build.sh` | No CMake, quick builds |

**Recommended:** Use `make` for the best experience!
